<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Propiedades Nievas - Sistema Inmobiliario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
    <style>
         :root {
            --brand-teal: #14b8a6;
            --brand-teal-dark: #0f766e;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            transition: background .3s, color .3s;
        }
        
        .dark {
            background: #000;
            color: var(--brand-teal-dark);
        }
        
        .light {
            background: #fff;
            color: #111;
        }
        
        .card,
        .property-card {
            border-radius: 16px !important;
            border: 1px solid rgba(20, 184, 166, .35) !important;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .28) !important;
        }
        
        .card:hover,
        .property-card:hover {
            box-shadow: 0 16px 34px rgba(20, 184, 166, .25) !important;
        }
        
        body.light .card,
        body.light .property-card {
            background: #fff !important;
            border: 1px solid #cfe7e4 !important;
        }
        
        #btn-volver-nievas {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--brand-teal);
            color: #000;
            border-radius: 9999px;
            padding: 10px 16px;
            font-weight: 700;
            box-shadow: 0 5px 16px rgba(20, 184, 166, .35);
        }
    </style>
</head>

<body class="dark">
    <!-- Header -->
    <header class="bg-black border-b border-[#0f766e] sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between">
            <!-- Marca -->
            <div class="flex items-center space-x-3">
                <img src="Logo.png" alt="Propiedades Nievas" class="h-12 w-12 object-contain bg-white rounded-full p-1" />
                <span class="text-[#0f766e] text-2xl font-bold leading-tight tracking-wide">
          Propiedades<br><small class="text-[#14b8a6] text-base font-semibold">NIEVAS</small>
        </span>
            </div>

            <!-- Barra de búsqueda -->
            <div class="flex items-center bg-black border border-[#0f766e] rounded-md px-3 py-2 mt-3 md:mt-0 w-full md:w-1/3">
                <input id="search-input" type="text" placeholder="Buscar por nombre, tipo u operación…" class="bg-black text-[#0f766e] placeholder-[#0f766e] focus:outline-none flex-grow" />
                <button id="search-btn" type="button" aria-label="Buscar">
          <i class="fas fa-search text-[#14b8a6] ml-2"></i>
        </button>
            </div>

            <!-- Iconos -->
            <div class="flex space-x-6 mt-3 md:mt-0">
                <div id="toggle-theme" class="flex flex-col items-center text-[#0f766e] hover:text-[#14b8a6] cursor-pointer">
                    <i id="theme-icon" class="fas fa-moon fa-lg"></i>
                </div>
                <a href="index.html" class="flex flex-col items-center text-[#0f766e] hover:text-[#14b8a6]">
                    <i class="fas fa-home fa-lg"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <section class="mb-20" id="propiedades">
            <h2 class="text-3xl font-bold text-[#14b8a6] mb-8 text-center">Propiedades Disponibles</h2>

            <!-- ✅ FILTROS NUEVOS -->
            <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

                <select id="filtro-tipoPropiedad" class="bg-black border border-[#0f766e] text-[#0f766e] p-2 rounded">
                    <option value="">Tipo de Propiedad</option>
                    <option value="casa">Casa</option>
                    <option value="departamento">Departamento</option>
                    <option value="campo">Campo</option>
                    <option value="cochera">Cochera</option>
                    <option value="chalet">Chalet</option>
                </select>

                <select id="filtro-operacion" class="bg-black border border-[#0f766e] text-[#0f766e] p-2 rounded">
                    <option value="">Tipo Operación</option>
                    <option value="venta">Venta</option>
                    <option value="alquiler">Alquiler</option>
                    <option value="venta_alquiler">Venta y Alquiler</option>
                </select>

                <input type="number" id="filtro-precio-min" placeholder="Precio mínimo"
                    class="bg-black border border-[#0f766e] text-[#0f766e] p-2 rounded" />

                <input type="number" id="filtro-precio-max" placeholder="Precio máximo"
                    class="bg-black border border-[#0f766e] text-[#0f766e] p-2 rounded" />

            </div>

            <!-- Grid -->
            <div id="propiedades-lista" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-black border-t border-[#0f766e] py-6 text-center text-[#0f766e]">
        <p>© 2025 Propiedades Nievas. Todos los derechos reservados.</p>
    </footer>

        <!-- App Script -->
    <script>
        (function() {

            // ---------- helpers ----------
            function norm(s) {
                return (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
            }

            const ALIAS_TIPO = {
                "casa": "casa",
                "casas": "casa",
                "departamento": "departamento",
                "departamentos": "departamento",
                "terreno": "campo",
                "terrenos": "campo",
                "campo": "campo",
                "local": "chalet",
                "locales": "chalet",
                "chalet": "chalet",
                "cochera": "cochera",
                "cocheras": "cochera"
            };

            function resolverTipoTerm(term) {
                const t = norm(term);
                return ALIAS_TIPO[t] || "";
            }

            const COLECCION_POR_TIPO = {
                "Casa": "Casas",
                "Departamento": "Departamentos",
                "Campo": "Campos",
                "Chalet": "Chalets",
                "Cochera": "Cocheras"
            };

            // ---------- render ----------
            function renderProperties(list) {
                const container = document.getElementById("propiedades-lista");
                container.innerHTML = "";
                if (!list || list.length === 0) {
                    container.innerHTML = "<p class='text-center text-[#0f766e] w-full text-lg font-semibold'>No se encontraron propiedades.</p>";
                    return;
                }
                list.forEach((p) => {
                    const img = `/imagen/${p.coleccion}/${p._id}`;
                    const detalle = `detalle.html?tipo=${encodeURIComponent(p.coleccion)}&id=${encodeURIComponent(p._id)}`;
                    container.insertAdjacentHTML("beforeend", `
          <article class="property-card bg-black border border-[#0f766e] rounded-xl overflow-hidden transition-shadow duration-300">
            <img src="${img}" alt="${(p.titulo||'Propiedad')}" class="w-full h-48 object-cover" onerror="this.src='/img/no-image.png'"/>
            <div class="p-4 text-[#0f766e]">
              <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold mb-2">${p.titulo || '(Sin título)'}</h3>
                <span class="text-xs bg-[#0f766e] text-black px-2 py-1 rounded">${p.tipoOperacion || p.tipo || ''}</span>
              </div>
              ${p.dormitorios ? `<p><i class='fas fa-bed mr-2'></i>${p.dormitorios} Hab.</p>` : ''}
              ${p.bano ? `<p><i class='fas fa-bath mr-2'></i>${p.bano} Baños</p>` : ''}
              <p><i class='fas fa-ruler-combined mr-2'></i>${p.suptotal || 0} m²</p>
              <p class="font-semibold text-[#14b8a6] text-lg mt-2">$ ${p.precio != null ? (p.precio).toLocaleString('es-AR') : 'Consultar'}</p>
              <a href="${detalle}" class="text-blue-400 hover:underline mt-2 inline-block">Ver detalles →</a>
            </div>
          </article>
        `);
                });
            }

            window.renderProperties = renderProperties;

            // ---------- carga desde backend ----------
            async function cargarPropiedades() {
                try {
                    const endpoints = [
                        { url: '/api/Casas', tipo: 'Casa' },
                        { url: '/api/Departamentos', tipo: 'Departamento' },
                        { url: '/api/Campos', tipo: 'Campo' },
                        { url: '/api/Chalets', tipo: 'Chalet' },
                        { url: '/api/Cocheras', tipo: 'Cochera' },
                    ];
                    let todas = [];
                    for (const ep of endpoints) {
                        const res = await fetch(ep.url);
                        if (!res.ok) continue;
                        const props = await res.json();
                        props.forEach(p => {
                            p.tipo = ep.tipo;
                            p.coleccion = COLECCION_POR_TIPO[ep.tipo];
                        });
                        todas = todas.concat(props);
                    }
                    propiedadesCargadas = todas;
                    aplicarFiltros();
                } catch (e) {
                    console.error("Error cargando propiedades:", e);
                    propiedadesCargadas = [];
                    renderProperties([]);
                }
            }

            // ---------- estado ----------
            let propiedadesCargadas = [];
            cargarPropiedades();

            // ---------- filtros ----------
            const inputBuscar = document.getElementById("search-input");
            const filtroTipo = document.getElementById("filtro-tipoPropiedad");
            const filtroOp = document.getElementById("filtro-operacion");
            const filtroPrecioMin = document.getElementById("filtro-precio-min");
            const filtroPrecioMax = document.getElementById("filtro-precio-max");

            function aplicarFiltros() {
                let lista = [...propiedadesCargadas];
                const q = norm(inputBuscar.value || "");

                // Filtro búsqueda
                if (q) {
                    const tipoCanon = resolverTipoTerm(q);
                    lista = lista.filter(p => {
                        const byNombre = norm(p.titulo).includes(q);
                        const byTipo = tipoCanon ? norm(p.tipo) === tipoCanon : false;
                        const byOperacion = norm(p.tipoOperacion || "").includes(q);
                        return byNombre || byTipo || byOperacion;
                    });
                }

                // Filtro tipo propiedad
                const ftipo = norm(filtroTipo.value);
                if (ftipo) {
                    lista = lista.filter(p => norm(p.tipo) === ftipo);
                }

                // Filtro operación
                const fop = norm(filtroOp.value);
                if (fop) {
                    lista = lista.filter(p => norm(p.tipoOperacion) === fop);
                }

                // Filtro precio
                const pmin = parseFloat(filtroPrecioMin.value);
                const pmax = parseFloat(filtroPrecioMax.value);
                lista = lista.filter(p => {
                    const precio = Number(p.precio) || 0;
                    if (!isNaN(pmin) && precio < pmin) return false;
                    if (!isNaN(pmax) && precio > pmax) return false;
                    return true;
                });

                renderProperties(lista);
            }

            // Eventos en vivo
            [inputBuscar, filtroTipo, filtroOp, filtroPrecioMin, filtroPrecioMax]
                .forEach(el => el && el.addEventListener("input", aplicarFiltros));

            // ---------- tema ----------
            const body = document.body;
            const tbtn = document.getElementById("toggle-theme");
            const icon = document.getElementById("theme-icon");
            const saved = localStorage.getItem("nievas-theme");
            if (saved === "light") applyLight();

            function applyLight() {
                body.classList.remove("dark");
                body.classList.add("light");
                icon.classList.remove("fa-moon");
                icon.classList.add("fa-sun");
                localStorage.setItem("nievas-theme", "light");
            }
            function applyDark() {
                body.classList.remove("light");
                body.classList.add("dark");
                icon.classList.remove("fa-sun");
                icon.classList.add("fa-moon");
                localStorage.setItem("nievas-theme", "dark");
            }
            if (tbtn) {
                tbtn.onclick = function() {
                    const current = localStorage.getItem("nievas-theme");
                    current === "light" ? applyDark() : applyLight();
                };
            }
        })();
    </script>

    <button id="btn-volver-nievas" onclick="if(document.referrer){history.back();}else{window.location.href='index.html';}">← Volver</button>
</body>
</html>
